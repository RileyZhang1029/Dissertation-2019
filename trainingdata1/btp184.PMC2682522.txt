BIOINFORMATICS APPLICATIONS NOTE Vol. 25 no. 11 2009, pages 1463–1465

doi:10.1093/bioinformatics/btp184

Systems biology
Globally optimal stitching of tiled 3D microscopic image
acquisitions
Stephan Preibisch, Stephan Saalfeld and Pavel Tomancak∗

Max Planck Institute of Molecular Cell Biology and Genetics, Pfotenhauerstrasse 108, Dresden, Germany
Received and revised on January 30, 2009; accepted on March 26, 2009
Advance Access publication April 3, 2009
Associate Editor: Trey Ideker

ABSTRACT
Motivation: Modern anatomical and developmental studies often
require high-resolution imaging of
large specimens in three
dimensions (3D). Confocal microscopy produces high-resolution 3D
images, but is limited by a relatively small ﬁeld of view compared with
the size of large biological specimens. Therefore, motorized stages
that move the sample are used to create a tiled scan of the whole
specimen. The physical coordinates provided by the microscope
stage are not precise enough to allow direct reconstruction (Stitching)
of the whole image from individual image stacks.
Results: To optimally stitch a large collection of 3D confocal images,
we developed a method that, based on the Fourier Shift Theorem,
computes all possible translations between pairs of 3D images,
yielding the best overlap in terms of the cross-correlation measure
and subsequently ﬁnds the globally optimal conﬁguration of the
whole group of 3D images. This method avoids the propagation of
errors by consecutive registration steps. Additionally, to compensate
the brightness differences between tiles, we apply a smooth, non-
linear intensity transition between the overlapping images. Our
stitching approach is fast, works on 2D and 3D images, and for
small
image sets does not require prior knowledge about the tile
conﬁguration.
Availability: The implementation of this method is available as an
ImageJ plugin distributed as a part of the Fiji project (Fiji is just
ImageJ: http://paciﬁc.mpi-cbg.de/).
Contact: tomancak@mpi-cbg.de

1 INTRODUCTION
There is an increasing demand to image complete biological
specimens with high resolution in two and three dimensions.
Biologists use Confocal, Bright ﬁeld or Electron microscopes
equipped with motorized stages to stepwise image large areas using
high magniﬁcations. The acquired image tiles have to be combined
into one ﬁnal output image by a process usually referred to as
Stitching. Motorized stages used for such acquisitions operate with
high precision, however, in most cases the physical coordinates from
the stage are not precise enough to provide a proper reconstruction
of the whole acquisition on the pixel level. Moreover, in some cases
the approximate conﬁguration of the tiles may be unknown.

To overcome these problems, we present a method capable
of stitching sets of 2D and 3D images. The method uses phase

∗

To whom correspondence should be addressed.

Fig. 1. Stitching results. (A) The 3D visualization of stitched 2× 3 mosaic
of the central nervous system of a Drosophila larva (Table 1, row 2). The
displacements of individual 3D stacks are artiﬁcially exaggerated. (B,C) A
close up of the border between adjacent tiles as recorded by the microscope
stage (B) and after the application of the stitching method (C).

correlation (Kuglin and Hines, 1975) to ﬁnd the translation
between all image pairs and registers multi-tile acquisitions globally
minimizing all pairwise registration errors. The global approach
allows stitching even without prior knowledge of tile conﬁguration.
Additionally, we implemented non-linear blending to compensate
brightness differences between the image tiles to create artifact-free,
stitched output images.

2 METHODS
The acquisition results in a set of n image tiles where a subset overlaps such
that all images form a connected graph. The method has to determine the
correct overlap for all tiles and create a properly registered output image
containing all image tiles that are connected to the graph.

We assume all transformations between overlapping tiles to be translation
only which is reasonable for most commonly used microscopy techniques
where the static, ﬁxed sample rests on a level microscope slide moved by a
motorized stage.

2.1 Phase correlation and fast Fourier transform
We use the Fourier transform (F)-based phase correlation method (PCM)
(Kuglin and Hines, 1975) to compute translational offsets between images.
If two images A and B are related by translation, the shift (x,y,z)T can be
computed from inverse Fourier transform (F−1) of the phase correlation

 2009 The Author(s)
This is an Open Access article distributed under the terms of the Creative Commons Attribution Non-Commercial License (http://creativecommons.org/licenses/
by-nc/2.0/uk/) which permits unrestricted non-commercial use, distribution, and reproduction in any medium, provided the original work is properly cited.

[11:49 14/5/2009 Bioinformatics-btp184.tex]

Page: 1463

1463–1465

S.Preibisch et al.

matrix Q(cid:2)F(A),F(B)

(cid:3)
. It is theoretically represented by a single peak (δ-
function) whose location deﬁnes the correct translation vector between the
images.
In real images, however, F−1(Q) contains several peaks marking different
translations with high correlation. Moreover, each peak describes eight
different possible translations (in 3D) due to the periodicity of the Fourier
space. To determine the correct shift, we select the n highest local maxima
(3×3×3 neighborhood) from F−1(Q) and evaluate their eight possible
translations by means of cross-correlation on the overlapping area of the
images A,B. The peak with the highest correlation is selected as translation
between the two images. If none of the peaks is above a certain limit the
tiles are assumed to be non-overlapping.
The Fourier transform F is computed using the multi-threaded Prime
Factor Fast Fourier Transform (PFFFT) (Good, 1958). Prior to performing
the PFFFT the input images have to be extended to a size supported by that
algorithm. To overcome sharp edges resulting from zero padding, we extend
the images by the mirrored image content faded from its real intensity to
black using an exponential windowing function. In this way, the periodicity
is not broken and real image information is preserved as only the mirrored
parts are faded out. The resulting images are zero-padded to dimensions
supported by the PFFFT algorithm.

2.2 Globally optimized registration
The PCM results in a set of translations P=((cid:3)pAB: A,B∈ V) with V being
the set of all tiles, and each (cid:3)pAB mapping tile A to an overlapping tile B
maximizing the pairwise alignment quality. Consecutive placement of tiles
into the output image would lead to the propagation of alignment errors as
the independent pairwise transforms may conﬂict when the position of a
tile is deﬁned by more than one neighbor. We avoid error propagation by
minimizing the sum of all pairwise transfer errors by means of least squares.
Given that F∈ V is a ﬁxed tile that deﬁnes the common reference frame, the
optimal conﬁguration TVF ={(cid:3)tAF : A,F∈ V} is deﬁned as

(cid:4)
A∈V\{F}

argmin
TVF

⎛
⎝ (cid:4)
B∈V\{A}

(cid:5)(cid:3)tBF −(cid:3)tAF −(cid:3)pAB(cid:5)2

⎞
⎠

The solution of this term gives the set of all translational parameters
and the displacement relative to the initially estimated pairwise translation
(Table 1). Overlapping tiles for which no initial translation was found may
still be connected through other images. Additionally, by checking the ratio
between maximal and average displacement, we are able to detect misaligned
tiles, where pairwise PCM failed to identify correct translation. If the
maximal displacement is signiﬁcantly larger than the average displacement
then the alignment of the image pair with the highest displacement is removed
and TVF is recalculated. If tiles become disconnected from all their neighbors
they will not contribute to the output image. These are usually tiles without
content.

2.3 Non-linear blending
Microscopic acquisitions suffer from shading, a position-dependent additive
term to the pixel intensity resulting in clearly visible brightness differences
in the overlapping areas of adjacent tiles. Background subtraction prior to
stitching is problematic for confocal microscopy images that lack background
intensities in the absence of a specimen.

To compensate for shading differences between tiles, we apply a weighting
factor to each pixel in each contributing tile. The applied factor is based on
the exponentially weighted distance of the current pixel coordinate from
its own tile boundary. Thus, the non-linear blending creates a weighting
map for each tile that has high inﬂuence on the central pixels and zero
inﬂuence on pixels at the edge of the image. The non-linearity of the 3D
weight function is determined by the tunable parameter α [α=0 blending by

1464

Table 1. Examples of stitching performance on tiled microscopy data
computed on an Intel® Quad-Core CPU machine with 2.67GHz and 24GB
of RAM

Tiles

3
6
24
72
63

Single-tile
dimension
10242 × 42
5122 × 86
10242 × 68
5122 × 122
10242 × 92

Output image Comp. time Min/avg/max
size

(min:sec)

displacement (pixel)

108 MB
350 MB
1.2 GB
1.9 GB
5.4 GB

0:42
1:20
22:43
43:10
178:57

0.00/0.00/0.00
0.60/0.77/1.05
0.49/0.76/0.99
0.00/0.39/0.64
0.00/0.66/1.18

The global alignment adjusts the position of individual tiles up to about 1pixel.The six
tile dataset in row 2 is RGB all other are gray-scale.

averaging, α=1 linear blending (Brown and Lowe, 2007), α >1 non-linear
blending).

3 RESULTS AND DISCUSSION
We used the presented method to reconstruct several types of tiled
microscopy acquisitions (Table 1, Fig. 1) ranging from mosaics of
histological 2D images to sets of gray-scale and RGB 3D confocal
stacks. The reconstructed images show no stitching artifacts, either
from misalignments or from intensity leaps in the overlapping areas
(http://ﬂy.mpi-cbg.de/preibisch/stitching.html).

The globally optimized registration ﬁnishes with low average and
maximal displacement and does not discard any non-uniform image
tiles (Table 1). Moreover, the method is capable of reconstructing
even mosaics with an unknown conﬁguration of the tiles. In
this case, the PCM is computed for all tile pairs (i.e. all tiles
are assumed to overlap), connections that result in inconsistent
or
low-quality alignments are sequentially dropped from the
connection graph until only the truly overlapping tiles remain in
the graph.

The program is fully multi-threaded taking advantage of multi-
core CPUs. Typically, registration consumes signiﬁcantly less time
than image acquisition. The method is applicable to virtually any
type of microscopy image data as it uses LOCI bioformat standard
for import. The method is implemented as a plugin for the fully
open source ImageJ (Rasband, 2008) distribution called Fiji that is
actively maintained and expanded by an international community of
developers ensuring long-term availability and future improvements
of the stitching method. All operations of the plugin and the
required parameters are extensively documented (http://ﬂy.mpi-
cbg.de/preibisch/manual).

The described stitching algorithm represents an open source
solution for efﬁcient reconstruction of large 2D and 3D image
mosaics, which will become increasingly important for analysis
of large biological specimens with the high resolution offered by
modern microscopy techniques.

ACKNOWLEDGEMENTS
We thank James W. Truman, Nicolas Gompel and Simone Fietz for
providing unpublished images. We also thank Benjamin Schmidt
and the Fiji team for providing programming libraries.

Conﬂict of Interest: none declared.

[11:49 14/5/2009 Bioinformatics-btp184.tex]

Page: 1464

1463–1465

REFERENCES
Brown,M. and Lowe,D.G. (2007) Automatic panoramic image stitching using invariant

features. Int. J. Comput. Vis., 74, 59–73.

Good,I.J. (1958) The interaction algorithm and practical Fourier analysis. J. R. Stat.

Soc. B, 20, 361–372.

Kuglin,C.D. and Hines,D.C. (1975) The phase correlation image alignment method.
In Proceedings of the IEEE, International Conference on Cybernetics and Society,
pp. 163–165.

Rasband,W.

(1997–2008)

ImageJ:

image processing and analysis

in Java

[version 1.40g].

Globally optimal stitching

[11:49 14/5/2009 Bioinformatics-btp184.tex]

Page: 1465

1463–1465

1465

