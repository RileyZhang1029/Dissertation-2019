BIOINFORMATICS Vol.25 ISMB 2009, pages i187 i195 doi:10.1093/bioinformatics/btp227 Multi-locus match probability in a ﬁnite population: a fundamental difference between the Moran and Wright Fisher models Anand Bhaskar1 and Yun S. Song1,2, 1Computer Science Division and 2Department of Statistics, University of California, Berkeley, CA, USA importance to forensic science, ABSTRACT Motivation: A fundamental problem in population genetics, which being also of is to compute the match probability (MP) that two individuals randomly chosen from a population have identical alleles at a collection of loci.
At present, 11 13 unlinked autosomal microsatellite loci are typed for forensic use.
In a ﬁnite population, the genealogical relationships of individuals can create statistical non-independence of alleles at unlinked loci.
However, the so-called product rule, which is used in courts in the USA, computes the MP for multiple unlinked loci by assuming statistical independence, multiplying the one-locus MPs at those loci.
Analytically testing the accuracy of the product rule for more than ﬁve loci has hitherto remained an open problem.
Results: In this article, we adopt a ﬂexible graphical framework to compute multi-locus MPs analytically.
We consider two standard models of random mating, namely the Wright Fisher (WF) and Moran models.
We succeed in computing haplotypic MPs for up to 10 loci in the WF model, and up to 13 loci in the Moran model.
For a ﬁnite population and a large number of loci, we show that the MPs predicted by the product rule are highly sensitive to mutation rates in the range of interest, while the true MPs computed using our graphical framework are not.
Furthermore, we show that the WF and Moran models may produce drastically different MPs for a ﬁnite population, and that this difference grows with the number of loci and mutation rates.
Although the two models converge to the same coalescent or diffusion limit, in which the population size approaches inﬁnity, we demonstrate that, when multiple loci are considered, the rate of convergence in the Moran model is signiﬁcantly slower than that in the WF model.
Availability: A C++ implementation of the algorithms discussed in this article is available at http://www.cs.berkeley.edu/ yss/software. html. Contact: yss@eecs.berkeley.edu 1 INTRODUCTION Correlation of genealogies at different loci can cause statistical non-independence of alleles at those loci.
It follows from the well-established population genetics theory that recombination breaks down this correlation and that in the case of an inﬁnite population, the correlation between unlinked loci (say, on different chromosomes) becomes completely eliminated over time.
In a ﬁnite population, however, genealogical relationships between individuals can create statistical dependence even between unlinked loci.
This subtle difference between ﬁnite and inﬁnite populations may have important implications for some practical questions of interest,  To whom correspondence should be addressed.
a well-known example being the forensic use of DNA typing.
A fundamental problem which arises in forensic science is to compute the probability that two individuals randomly chosen from a population have identical alleles at a collection of loci (Balding, 2005 Evett and Weir, 1998). We refer to this probability as multi-locus match probability (MP). In population genetics, MP corresponds to the probability of homozygosity. At present, 13 unlinked autosomal microsatellite loci, called the Combined DNA Index System loci (see http://www.fbi.gov/hq/lab/codis/index1.htm for details), are typed in the USA for forensic use, while 11 loci are used in the UK. Unlinked microsatellite data are also often used in demographic inference (e.g. see Pritchard et al. 2000), but we do not address that problem in this article.
The so-called product rule, which is used in courts, computes the MP for multiple unlinked loci by assuming statistical independence, multiplying the one-locus MPs at those loci.
In light of the above discussion regarding the existence of statistical dependence between unlinked loci in a ﬁnite population, it remains debatable to date whether the product rule produces reliable results.
To test the accuracy of the product rule theoretically, Laurie and Weir (2003) provided a method to compute the equilibrium MPs in an ideal ﬁnite population, assuming an inﬁnite alleles model of mutation.
Their approach was to construct a system of coupled linear recurrence equations involving MPs and then solve the system assuming stationarity. Although this method is simple in principle, setting up the system of recurrence equations becomes increasingly challenging with the number of loci.
Song and Slatkin (2007) later introduced a ﬂexible graphical method that allowed them to generalize the analysis of Laurie and Weir to cases with more loci and other models of mate choice such as monogamy.
Using their framework, Song and Slatkin succeeded in computing the genotypic (i.e. two alleles per locus per individual) MP for up to three loci and the haplotypic (i.e. one allele per locus per individual) MP for up to ﬁve loci.
In this article, we employ the graphical framework of Song and Slatkin (2007) and make algorithmic improvements to carry out the MP computation for signiﬁcantly more loci than what previous works could handle.
For simplicity, we focus on the haplotypic MP computation.
Hence, when we say MP in what follows, we mean haplotypic MP.
Both Laurie and Weir (2003) and Song and Slatkin (2007) restricted their attention to the Wright Fisher (WF) model of random mating.
In our work, we consider the Moran model in addition to the WF model the main difference between these two standard models in population genetics is that generations do not overlap in the WF model, while they do overlap in the Moran model.
We are currently able to compute MPs for up to 10 loci in the WF model and up to 13 loci in the Moran model.
Bear in mind that this work requires overcoming several algorithmic and  2009 The Author(s) This is an Open Access article distributed under the terms of the Creative Commons Attribution Non-Commercial License (http://creativecommons.org/licenses/ by-nc/2.0/uk/) which permits unrestricted non-commercial use, distribution, and reproduction in any medium, provided the original work is properly cited.
[10:11 15/5/2009 Bioinformatics-btp227.tex] Page: i187 i187 i195  A.Bhaskar and Y.S.Song engineering challenges.
For example, the 13-locus case involves about 3.1 million coupled linear equations both ﬁnding the system of linear equations and solving it are challenging tasks.
Two major ﬁndings of our work are as follows.
(i) In an ideal ﬁnite population, the MPs predicted by the product rule are highly sensitive to mutation rates, while the true MPs computed using our graphical framework are not.
For a range of mutation rates relevant to the observed level of homozygosity at microsatellite loci, the product rule may signiﬁcantly underestimate the 13-locus MP.
However, the product rule becomes more accurate if we are provided with the additional information that the individuals being compared are not close relatives.
(ii) Both the WF and Moran models have been used in the population genetics community for many years, and it has been thought that the two models should produce very similar quantitative results as long as the population size and time are rescaled properly when relating one model to the other.
However, our work reveals a fundamental difference between the two models which becomes transparent only when multiple loci are considered in a ﬁnite population.
More precisely, we show that, for a ﬁnite population, the Moran model may produce signiﬁcantly higher multi-locus MPs than that under the WF model, and that this difference grows with the number of loci and mutation rates.
We show that, as expected, the two models produce the same MPs in the coalescent or the diffusion limit, in which the population size approaches inﬁnity. We demonstrate that, when multiple loci are considered, the rate of convergence to the diffusion limit in the Moran model is signiﬁcantly slower than that in the WF model.
2 MODELS OF RANDOM MATING We adopt the same notational convention as in Song and Slatkin (2007). Throughout this article, we assume a neutral inﬁnite-alleles model i.e. whenever an allele mutates, it mutates to a new allele that has never been seen before.
Further, we assume a single population containing 2NWF haploid individuals in the WF model or 2NM haploid individuals in the Moran model.
2.1 Mating schemes The two mating schemes are detailed below.
2.1.1 The WF model The entire population of 2NWF haploid individuals gets replaced every generation.
Individuals in the next generation are produced from those in the current generation in the following fashion: (i) Randomly sample two individuals, each with replacement.
The same individual may be sampled twice under this mating scheme.
A new individual is produced from the two sampled individuals as described in Section 2.2.
We assume that mutations occur at locus i with probability μi per individual per generation, independently of other loci.
(ii) Repeat the above procedure until 2NWF new individuals are created for the next generation.
2.1.2 The Moran model Exactly one individual gets replaced every generation as follows.
(i) The same as Step (i) in the WF model.
(ii) Randomly choose exactly one individual to die in the current generation the new individual created in the previous step replaces this individual.
All other individuals survive to the next generation.
i188 2.2 Generating offspring gametes by recombination By a gamete, we mean alleles at a collection of loci different loci may physically reside on different chromosomes within a haploid individual.
We use xi to denote the allele at locus i in individual x.
2.2.1 Two loci Let x1x2 and y1y2 denote the gametes of the two sampled parental individuals.
Then, the inheritance pattern of the offspring is x1x2, y1y2, x1y2 or y1x2, with probability 2 (1 r), 1 2 (1 r), 1 1 2 r, respectively.
The unlinked case corresponds to r=1/2. 2.2.2 More than two loci Let x1x2...xL and y1y2  yL denote the 2 r or 1 two sampled parental gametes with L loci.
We focus on a set of loci that are pairwise unlinked, as was done previously by other authors (Laurie and Weir, 2003 Song and Slatkin, 2007). Hence, in the offspring gamete z1z2  zL, the allele zi at locus i is equally likely to have descended from xi or yi. The probability of any particular inheritance pattern is 1/2L. 3 A GRAPHICAL APPROACH TO MP COMPUTATION Song and Slatkin (2007) introduced a graphical framework to compute multi-locus MPs in a ﬁnite population.
We employ the same framework in this article.
Below, we highlight the key ideas underlying the approach.
3.1 High-level idea In Section 2, we discussed random mating models that describe how a population evolves forward in time.
In our work, we adopt a backward point of view and determine how a given MP at generation t is related to a combination of MPs at generation t 1, thus obtaining a system R(t,t 1) of recurrence equations.
At stationarity, the probability of a particular match relation (e.g., the probability that two randomly chosen individuals have the same alleles at loci 1 and 4) at generation t is equal to the probability of the same match relation at generation t 1.
Therefore, at stationarity R(t,t 1) becomes a closed system S of linear equations which we can solve.
In general, the recurrence equation for an L-locus MP at generation t contains k-locus MPs at generation t 1 where k L. Therefore, one needs to carry out the computation in the following systematic order: ﬁrst solve the system of linear equations for 1 locus then solve the system for two loci, treating 1-locus MPs as known constants then solve the system for three loci, treating 1-locus and 2-locus MPs as known constants so on and so forth.
Although the above procedure is simple to describe, setting up the system of recurrence equations becomes increasingly difﬁcult with the number of loci.
The key idea introduced by Song and Slatkin (2007) is to represent MPs as graphs.
By performing a set of prescribed operations on a given graph at generation t, one can determine how it is related to a linear combination of graphs at generation t 1, thus setting up the required system R(t,t 1) of recurrence equations.
The graphical method makes the combinatorial structure of the problem easier to understand and it is possible to implement the method in a fully automated computer program, thus reducing the chance of human error.
[10:11 15/5/2009 Bioinformatics-btp227.tex] Page: i188 i187 i195  1 2 3 :. L  1 L Multi-locus match probability in a ﬁnite population split the vertex x into exactly two vertices v1 and v2, distributing the set of edges that used to be incident with x to v1 and v2. In the WF model, more than one vertex in the original graph may split, while in the Moran model at most one vertex may split.
A graph resulting from performing a set of splits allowed in a single generation is called a split graph.
Fig.1.
The match graph corresponding to the probability that two randomly chosen individuals have matching alleles at L loci.
This probability is denoted by PWF L in the WF and Moran models, respectively.
L and PM 3.2 From MPs to match graphs Here, we describe the graphical framework in the case of arbitrary i=1,...,L. (As we will discuss in mutation rates μi at Section 6.1, there is a simpliﬁed representation if μi are the same for all i.) Let xi yi denote the event that alleles at locus i are identical (or match) in individuals x and y.
To the probability of a particular match relation (e.g. x1 y1,x2 y2 and x3 z3), associate a match loci graph constructed as follows: 1.
Create a vertex labeled x for individual x.
2.
Draw an undirected edge labeled i between vertices x and y if and only if xi yi. 3.
Remove all vertex labels.
The reason for removing all vertex labels in the last step is as follows.
Any two MPs are equal under random mating if they are related by some permutation of the labels of individuals.
For example, P(x1 y1,x2 z2) and P(x1 y1,y2 z2) are equal under random mating.
In terms of our graphical representation, such an equality of MPs translates to the statement that two fully labeled graphs (in which all vertices and edges are labeled) are equivalent if they are isomorphic as edge-labeled graphs (i.e. ignoring vertex labels). An L-locus match graph has L edges, one for each locus.
Shown in Figure 1 is the match graph corresponding to P(x1 y1,...,xL  yL), the probability that two randomly chosen individuals have matching alleles at L loci.
We use PWF L to denote this L-locus MP in the WF and Moran models, respectively.
Our main objective is to compute PWF L in equilibrium, we need to ﬁnd a system of coupled linear equations in which PWF L appears as one of the unknown variables as we will see in Section 6.1, the total number of unknown variables in such a system grows extremely fast as the number of loci increases.
L. To solve for PWF L and PM L and PM 3.3 Vertex split and merge operations Given a number of individuals at generation t and a match relation involving them, the probability of the match relation can be written as a linear combination of MPs involving their parents.
Recall that, forward in time, a reproduction event involves choosing two individuals (each with replacement) and creating a new offspring gamete from the two chosen gametes via recombination and mutation.
To capture this model of reproduction, we consider the following two kinds of operations on match graphs: to represent recombination Consider an 3.3.1 Vertex split individual x whose alleles at k 1 loci are involved in a match relation.
In the graph corresponding to that match relation, the degree of vertex x is k. If the alleles at the k loci trace back to two parental gametes as a consequence of recombination (c.f. Section 2.2), then 3.3.2 Vertex merge to represent sharing a common parent Two or more gametes at generation t may trace back to a common parental gamete at generation t 1.
This sharing of a parental gamete translates to merging vertices in the split graph into a single vertex.
Any isolated vertex that results from merge operations can be discarded from the resulting match graph since such a vertex is not involved in any match relation.
If a graph becomes empty from discarding isolated vertices, the probability associated with it is 1.
By performing all possible split-and-merge operations on a given match graph G at generation t, we obtain a set of match graphs (cid:6) G 1 a well-deﬁned probability associated with it, determined by the assumed model of random mating.
(See Sections 4 and 5 for details.) These probabilities are used as coefﬁcients in the equation that represents G as a linear combination of G (cid:6) k at generation t 1.
Each split-and-merge operation has ,...,G (cid:6) (cid:6) 1,...,G k. 4 THE GRAPHICAL FRAMEWORK FOR THE WF MODEL In this section, we brieﬂy review the graphical framework for the WF model, which was considered in detail by Song and Slatkin (2007). The reader should refer to that paper for a detailed explanation.
Let G be a match graph with vertex set VG. Given a vertex v VG, we use d(v) to denote its degree.
We focus on the case with unlinked loci.
4.1 Probability associated with a vertex split In a match graph G, consider a vertex v with degree d 1, and suppose that edges incident with v are bijectively labeled by I = i1,i2,...,id. Let B(cid:8) B denote a bipartition of I into two disjoint subsets.
There are 2d 1 inequivalent bipartitions of I.
Each bipartition has probability 1/2d 1 and corresponds to splitting v into two vertices, such that the edges labeled by B become incident with one vertex and the edges labeled by B become incident with the other vertex.
4.2 Probability associated with a vertex merge Suppose that a split graph GS contains n vertices.
For ease of discussion, label the vertices by [n]= 1,...,n. In the WF model, disjoint subsets of [n] may each merge into a single vertex.
More generally, there exists an one-to-one correspondence between the set of all vertex merge operations on GS and the set of all partitions of [n] into non-empty subsets, with each subset corresponding to those vertices that merge into a single vertex.
A partition of [n] into k non-empty subsets deﬁnes a particular case of assigning n labeled individuals to k distinct unlabeled parents, with each parent having at the probability of a particular set of vertex merges in GS such that k vertices remain, is given by (2NWF)(k)/(2NWF)n, where z(k) denotes the falling factorial z(z 1)  (z k+1). least one child.
Hence, i189 [10:11 15/5/2009 Bioinformatics-btp227.tex] Page: i189 i187 i195  A.Bhaskar and Y.S.Song i  x2 ,...,xk i    xk 4.3 Probability associated with mutation Let x1  denote a set of alleles at locus i in k individuals at time t. In the inﬁnite-alleles model, x1 i only if their parental alleles in generation t 1 all match and no mutation occurs i between generations t 1 and t in the lineages relating x1  ,...,xk i to their parents.
Hence, the probability of any match relation at time t that requires x1 i must contain an overall factor of (1 μi)k when written in terms of MPs at time t 1.
This fact i translates to the following statement in our graphical representation: given a vertex v VG, deﬁne    xk  x2 i i i 1 if an edge labeled i is incident with v, 0 otherwise.
(1) (cid:2) δi(v):= i=1 L This is an indicator variable for whether the individual v is involved (cid:3) in a match relation at locus i.
In an L-locus match graph, d(v)= relations at locus i is denoted by δi(G):=(cid:3) δi(v). The total number of individuals involved in match v V(G) δi(v). When relating G to graphs in the previous generation, we need to include an overall factor of i=1(1 μi)δi(G). (cid:4) L 5 THE GRAPHICAL FRAMEWORK FOR THE MORAN MODEL In this section, we consider the graphical framework for the Moran model, which was not considered in Song and Slatkin (2007). We consider performing split-and-merge operations on a given match graph G with vertex set VG, where VG = k. As before, d(v) denotes the degree of a vertex v VG and δi(v) is deﬁned as in (1). 5.1 Coefﬁcients in the recurrence equation Below we describe the probabilities associated with vertex split- and-merge operations in the case of completely unlinked loci.
In the Moran model, exactly one individual in the entire population is a newborn.
This condition puts tight restrictions on the allowed split-and-merge operations.
In particular, at most one vertex may undergo a split.
In what follows, we list the allowed split-and-merge operations.
For ease of notation, deﬁne, for v VG, m(v):= L(cid:5) i=1 (1 μi)δi(v). 5.1.1 No vertex splits involved in a merge.
All possible cases are as follows.
In this case, at most two vertices may be p00:= 2NM k (cid:129) 0 merge: G G. The associated probability is (cid:6) v VG (2) 2NM (cid:129) 1 merge: G G , with VG = k and VG(cid:6) = k 1.
Let u and v denote the vertices that merge.
The following probability is for that particular merge operation: + (2NM k+1) (2NM)2 m(v) 2d(v) 1 (cid:6). p01(u,v):= 1 m(u) 2d(u) 1 + m(v) 2d(v) 1 (2NM)2 (3) 5.1.2 Exactly one vertex splits Let v VG with d(v) 1 be the vertex that splits, and let x,y denote the new vertices created by the split operation.
The following probabilities are for a particular split.
(cid:7) (cid:8) operation at v (i.e. a particular non-trivial bipartition of the edges incident with v). , with VG = k and VG(cid:6) = k+1. The (cid:6) (cid:129) 0 merge: G G associated probability is p10(v):= (2NM k+1)(2NM k) (2NM)3  m(v) 2d(v) 1.
(4) (cid:129) 1 merge:  G G. Here, x and y merge with each other.
The associated probability is p11a(v):= 2NM k+1  m(v) 2d(v) 1.
(cid:6)  G G (5) , with VG = k and VG(cid:6) = k. Exactly one of x and y merges with a vertex in VG\ v.
The following probability is for a particular merge operation: (2NM)3 p11b(v):= 2NM k+1 (6) (cid:6) , with VG = k and VG(cid:6) = k 1.
Here, x and y (cid:129) 2 merges: G G each merge with a vertex in VG\ v.
The following probability is for a particular set of merge operations for x and y:  m(v) 2d(v) 1 (2NM)3. p12(v):= 1 (2NM)3  m(v) 2d(v) 1.
(7) 5.2 Consistency check The recurrence equation for a particular match graph G(t) has the (cid:6) following form: G(t)= cj(μ,NM)Gj(t 1), (8) j (cid:3) where the summation is over those match graphs that can be obtained by performing vertex split-and-merge operations on G(t), and cj(μ,NM) are constants that depend on μ=(μ1,...,μL) and NM. For μi=0 for all i=1,...,L, then all MPs are identically equal j cj(0,NM)=1. We will now verify that the to 1, thus implying coefﬁcients shown in (2) (7) satisfy this consistency condition.
First, deﬁne S:= v VG d(v) 1 , which denotes the set of all vertices that can undergo splits, and let k= VG. Then, for μi=0, i, the right-hand side of (8) becomes (cid:6) (cid:9)(cid:10) 2d(v) 1 1 p00+ p10(v)+p11a(v)+2(k 1)p11b(v)+(k 1)2p12(v) p01(u,v)+  u,v VG:u(cid:13)=v. (cid:6) v S (cid:11) (cid:13)(cid:14) , (cid:12)   where the factor [2d(v) 1 1] corresponds to the total number of non-trivial bipartitions of the labeled edges incident with v. It is straightforward to show that this expression is exactly equal to 1.
Hence, the probabilities in Section 5.1 are consistent.
6 SIMPLIFICATION AND EXAMPLES Although split-and-merge operations allowed in the WF and Moran models are different, exactly the same set of inequivalent match graphs are involved in the systems of recurrence equations in the two models.
In the general case, the major computational obstacle is that there are too many match graphs to consider.
However, in the special case in which all loci have the same mutation rate, the i190 [10:11 15/5/2009 Bioinformatics-btp227.tex] Page: i190 i187 i195  Table 1.
The number α(k) [respectively, β(k)] of inequivalent loopless multigraphs with k labeled (respectively, unlabeled) edges and non-isolated vertices Multi-locus match probability in a ﬁnite population α(k) β(k) Fig.2.
1-Locus recurrence equations for the WF model.
k 1 2 3 4 5 6 7 8 9 10 11 12 13 1 3 16 139 1 750 29 388 624 889 16 255 738 504 717 929 18 353 177 160 769 917 601 384 36 803 030 137 203 1 984 024 379 014 193 1 3 8 23 66 212 686 2 389 8 682 33 160 132 277 550 835 2 384 411 computation simpliﬁes dramatically, allowing us to compute MPs for 10 or more loci.
Below we describe this simpliﬁcation in detail and give a couple of examples to illustrate setting up recurrence equations.
6.1 Graph enumeration In the case of haplotypic MPs, there is a one-to-one correspondence between the set of inequivalent match graphs with k edges and the set of inequivalent loopless multigraphs with k edges and non- isolated vertices.
(Recall that a multigraph is a graph in which there may be more than one edge joining any pair of vertices.) Using this bijection, we can determine exactly how many inequivalent match graphs we need to consider.
The number α(k) of inequivalent loopless multigraphs with k distinctly labeled edges is shown in Table 1 for k=1,...,13 (Labelle, 2000). Such edge-labeled graphs are what we need to consider if mutation rates μi are all distinct at different loci, and the total number of inequivalent match graphs involved in the L-locus MP computation is given by A(L):= L(cid:6) k=1 (cid:15) (cid:16) L k α(k). Clearly, enumerating all such match graphs to compute the 13-locus MP is not tractable.
However, if μi= μ, for all i=1,...,13, then we do not need to distinguish loci, thus allowing us to remove edge labels.
This property considerably reduces the total number of inequivalent graphs we need to consider, simplifying the computation signiﬁcantly. Shown in Table 1 is the number β(k) of inequivalent loopless multigraphs with k unlabeled edges (Harary and Palmer, 1973). Note that β(k) grows much slower than does α(k) as k increases.
If all mutation rates are equal, the number of inequivalent match graphs that we need to consider for the L-locus MP computation reduces to B(L):= L(cid:6) k=1 β(k). (9) In what follows, we assume that μi are the same across all loci i.e. we set μi= μ for all i=1,...,L. Fig.3.
1-Locus recurrence equations for the Moran model.
Given a system of recurrence equations for edge-labeled graphs, a system for edge-unlabeled graphs can be obtained by summing over the coefﬁcients of edge-labeled graphs that are equivalent as edge-unlabeled graphs.
6.2 The 1-locus recurrence equations In the WF model, the recurrence equation for the 1-locus MP PWF shown in Figure 2, which can be solved to yield 1 is (1 μ)2 = PWF 1 2NWF (1 μ)2(2NWF 1). (10) In the Moran model, the 1-locus MP PM equation shown in Figure 3, which implies 1 satisﬁes the recurrence = PM 1 (1 μ) 2NM (1 μ)(2NM 1). (11) 6.3 The 2-locus recurrence equations Shown in Figure 4 is a system of recurrence equations for 2-locus MPs in the Moran model.
It corresponds to the case with an arbitrary recombination rate r (c.f. Section 2.2) and mutation rates μi= μ for i=1,2. Before solving this system of three coupled equations, the 1-locus MP PM 1 should be computed ﬁrst as described in Section 6.2.
The system contains three unknowns and three coupled equations 2 (c.f. Fig.1) is one of the three unknowns.
The 2-locus system PM corresponding to the WF model is also simple to write down, but we do not show it here because of space constraint.
We refer the interested reader to Figure 10 of Song and Slatkin (2007). 7 IMPLEMENTATION DETAILS Computing the MPs for more than ﬁve loci requires overcoming several algorithmic and engineering challenges.
Described below are our solutions to some of these challenges.
The reader only interested in results may skip to Section 8.
7.1 Algorithm for computing MPs To compute PWF L in the Moran model, a L in the WF model or PM breadth-ﬁrst search (BFS) is performed starting with the L-locus match graph shown in Figure 1.
Given a match graph to explore, we perform all possible split-and-merge operations on that graph, and all newly encountered match graphs (i.e. inequivalent to the ones seen so far) get put in the BFS queue for subsequent exploration.
When the BFS terminates, we would have constructed a directed, edge-weighted BFS graph deﬁned as follows: (i) To each match graph, assign a vertex.
(ii) Draw a directed edge from vertex Gi to vertex Gj if the match graph Gj can be obtained from the match i191 [10:11 15/5/2009 Bioinformatics-btp227.tex] Page: i191 i187 i195  A.Bhaskar and Y.S.Song Fig.4.
The system of recurrence equations for 2-locus MPs in the Moran model with an arbitrary recombination rate r and μi = μ for i=1,2. graph Gi by performing vertex split-and-merge operations allowed in a single generation.
We say that Gj is a neighbor of Gi. (iii) Assign the associated split merge probability to each edge.
To avoid confusion with match graphs, we will call the above BFS graph a supergraph. This supergraph encodes a system of linear equations.
A match graph with outdegree 1 in the supergraph can be written as linear combination of its neighbors, with the corresponding edge weights taken as coefﬁcients in the linear combination.
Since performing split-and-merge operations on a given match graph never increases the number of edges, the supergraph produced by the BFS has L strongly connected components (SCC) C1,...,CL, with Ck containing all k-locus match graphs (each of which has exactly k edges). Hence, the linear system for the entire supergraph is naturally decomposed into L linear systems, one for each SCC, and they can be solved sequentially from C1 to CL.
7.2 Graph isomorphism testing During the BFS, when split-and-merge operations are performed on a particular match graph, it is possible to encounter a neighbor match graph which is isomorphic to one of the match graphs that has already been generated before.
To avoid putting redundant match graphs into the BFS queue and to set up the system of linear equations with the correct coefﬁcients, we therefore need an efﬁcient way to test graph isomorphism. There is no known polynomial- time algorithm for testing graph isomorphism for arbitrary graphs, but several heuristics have been suggested that work well for most graphs.
In our work, we use the nauty package (McKay, 2007) to generate a canonical permutation of the vertex labels of each graph.
The canonical permutation ensures that if two graphs are isomorphic, their adjacency matrices will be identical after applying their respective canonical permutations.
We hash the adjacency matrix of the canonically permuted graph and use this hash along with the adjacency matrix to store the graphs and test isomorphism. Match graphs in our framework are multigraphs, but nauty only deals with simple graphs (i.e. graphs with at most one edge between every pair of vertices). However, nauty supports the notion of colors for partitioning vertices, which is respected by the canonical permutation of vertex labels.
We take advantage of this feature to create a new colored simple graph from a match graph as follows: if vertices u and v have k 1 edges between them, we create a new vertex w with color k and create edges u,w and v,w. The original vertices of the match graph maintain a color of 1.
The canonical permutation can then be applied to this new graph for testing graph isomorphism as described before.
7.3 Order-2 truncation In the BFS, performing all possible split-and-merge operations on a given match graph G may produce many neighbors, but a signiﬁcant fraction of them might come with negligibly small edge weights (i.e. split-and-merge probabilities). To simplify the computation, we ignore all neighbors of G with edge weights of order 1/Nm where m 2 and N is either NWF or NM, depending on the model.
By ignoring neighbors, we mean removing edges from G to those neighbors in the supergraph. This approximation scheme is called order-2 truncation.
Song and Slatkin (2007) showed that it produces very accurate answers and we have independently veriﬁed this fact using our new implementation.
In the WF (respectively, Moran) model computation, we used order-2 truncation for all match graphs corresponding to 2 loci (respectively, 9 loci). 7.4 Solving the linear system In the WF model, the number of edges in the supergraph grows quadratically with the number of vertices in the supergraph. For L=13, the supergraph contains 3.1 106 vertices and at least 2 1012 edges, even if the above-mentioned order-2 truncation is used.
Storing the associated edge weights in 8 B double-precision data types is intractable, and therefore we pursued the WF model only up to 10 loci.
This is less of a problem in the Moran model, in which the supergraph has fewer edges than that in the WF model.
However, the linear system for 13 loci in the Moran model still has 3.1 106 coupled equations in just as many variables, and the standard Gaussian elimination with a cubic running time is not tractable.
Instead, we use the iterative Successive Over-Relaxation i192 [10:11 15/5/2009 Bioinformatics-btp227.tex] Page: i192 i187 i195  Table 2.
Comparison of L-locus MPs for the case with Ne=10000 and μi = μ for all loci i=1,...,L Multi-locus match probability in a ﬁnite population L 1 2 3 4 5 6 7 8 9 10 11 12 13 1 2 3 4 5 6 7 8 9 10 11 12 13 L π WF μ=1 10 4 2.00 10 1 4.00 10 2 8.00 10 3 1.60 10 3 3.20 10 4 6.40 10 5 1.28 10 5 2.56 10 6 5.11 10 7 1.02 10 7 2.05 10 8 4.09 10 9 8.18 10 10 μ=5 10 4 4.76 10 2 2.26 10 3 1.08 10 4 5.13 10 6 2.44 10 7 1.16 10 8 5.52 10 10 2.63 10 11 1.25 10 12 5.95 10 14 2.83 10 15 1.35 10 16 6.41 10 18 PWF L PM L π WF L PWF L PM L π WF L PWF L PM L 2.00 10 4.00 10 8.01 10 1.60 10 3.22 10 6.48 10 1.31 10 2.69 10 5.65 10 1.24 10  1 2 3 3 4 5 5 6 7 7 4.76 10 2.28 10 1.13 10 6.53 10 6.33 10 1.21 10 3.17 10 8.94 10 2.56 10 7.42 10  2 3 4 6 7 7 8 9 9 10 2.00 10 4.00 10 8.01 10 1.61 10 3.25 10 6.68 10 1.44 10 3.48 10 1.05 10 4.16 10 2.06 10 1.15 10 6.69 10  1 2 3 3 4 5 5 6 6 7 7 7 8 4.76 10 2.29 10 1.18 10 9.74 10 2.43 10 1.10 10 5.57 10 2.88 10 1.49 10 7.79 10 4.08 10 2.13 10 1.12 10  2 3 4 6 6 6 7 7 7 8 8 8 8  4 μ=2 10 1.11 10 1 1.23 10 2 1.37 10 3 1.52 10 4 1.69 10 5 1.88 10 6 2.09 10 7 2.32 10 8 2.57 10 9 2.86 10 10 3.18 10 11 3.53 10 12 3.92 10 13 μ=1 10 2.44 10 2 5.93 10 4 1.44 10 5 3.52 10 7 8.57 10 9 2.09 10 10 5.08 10 12 1.24 10 13 3.01 10 15 7.34 10 17 1.79 10 18 4.35 10 20 1.06 10 21  3 1.11 10 1 1.24 10 2 1.38 10 3 1.55 10 4 1.78 10 5 2.16 10 6 3.02 10 7 5.41 10 8 1.28 10 8 3.72 10 9 2.44 10 6.09 10 1.87 10 1.42 10 2.88 10 7.45 10 1.99 10 5.36 10 1.45 10 3.98 10  2 4 5 6 7 8 8 9 9 10 1.11 10 1 1.24 10 2 1.38 10 3 1.59 10 4 2.01 10 5 3.51 10 6 1.08 10 6 4.94 10 7 2.60 10 7 1.42 10 7 7.84 10 8 4.35 10 8 2.41 10 8 2.44 10 6.17 10 2.39 10 4.41 10 1.92 10 9.38 10 4.70 10 2.39 10 1.21 10 6.19 10 3.17 10 1.62 10 8.32 10  2 4 5 6 6 7 7 7 7 8 8 8 9  4 μ=3 10 7.69 10 2 5.91 10 3 4.55 10 4 3.50 10 5 2.69 10 6 2.07 10 7 1.59 10 8 1.22 10 9 9.39 10 11 7.22 10 12 5.55 10 13 4.27 10 14 3.28 10 15 μ=5 10 4.94 10 3 2.44 10 5 1.20 10 7 5.95 10 10 2.94 10 12 1.45 10 14 7.16 10 17 3.54 10 19 1.75 10 21 8.62 10 24 4.26 10 26 2.10 10 28 1.04 10 30  3 7.69 10 5.93 10 4.60 10 3.68 10 3.26 10 3.80 10 6.86 10 1.74 10 5.08 10 1.55 10  2 3 4 5 6 7 8 8 9 9 4.94 10 4.05 10 3.54 10 8.13 10 2.01 10 5.06 10 1.27 10 3.23 10 8.26 10 2.15 10  3 5 6 7 7 8 8 9 10 10 7.69 10 5.94 10 4.66 10 4.03 10 5.29 10 1.52 10 7.00 10 3.63 10 1.93 10 1.03 10 5.54 10 2.98 10 1.60 10  2 3 4 5 6 6 7 7 7 7 8 8 8 4.95 10 4.88 10 8.53 10 3.59 10 1.67 10 8.08 10 3.98 10 1.98 10 9.82 10 4.91 10 2.45 10 1.23 10 6.16 10  3 5 6 6 6 7 7 7 8 8 8 8 9 For the mutation rates shown above, the product rule MPs under the WF and Moran models are very close, so we only show the former π WF L.
method to solve the linear systems up to a relative error of 10 each variable.
9 for 7.5 Precomputing the supergraph structure The algorithm described above computes the MPs for a particular mutation rate μ. This computation takes about 24 h on a 2.8 GHz Opteron PC for the 13-locus MP computation in the Moran model.
Instead of repeating this expensive computation for different μ, we run the BFS procedure once and store the supergraph structure on disk without actually computing the edge weights (i.e. probabilities associated with split-and-merge operations). To compute the MPs for a speciﬁc μ, another program reads the supergraph from disk, calculates the probabilities associated with each edge of the supergraph using the speciﬁed μ and population size, and solves the linear system to determine the MPs. For the 13-locus computation in the Moran model, this program takes only about 3.5 h, of which 2 h are spent on reading the supergraph and match graphs into memory, and calculating edge weights in the supergraph. 8 RESULTS In this section, we summarize our main results.
To model a haploid population with effective population size 2Ne, we need to use NWF= Ne in the WF model and NM=2Ne in the Moran model (see Ewens 2004 p. 121 for explanation). follows, we consider a ﬁnite population with Ne=10 000, which is an approximate long-term effective population size of humans estimated from various genetic data (Harding et al., 1997 Harpending et al., 1998). Hence, we use NWF=10 000 in the WF model and NM=20 000 in the Moran model.
In what =(PWF 8.1 Accuracy of the product rule We use π WF L to denote the L-locus MP in the WF model obtained 1 )L. Table 2 shows π WF using the product rule note that π WF L , L L and PM L for six different values of μ. We do not show the product PWF rule MPs in the Moran model, since they are very close to π WF L for the mutation rates shown in the table.
The L-locus product rule MP π WF L shown in the table agrees very well with Ewens (1972) sampling formula (ESF): 1/(1+θ)L, where θ =4Neμ. As Table 2 illustrates, for a give mutation rate μ, the product rule becomes less accurate as the number of loci increases.
Furthermore, for a large number L of loci, a slight change in μ causes the product rule MP to decrease by a large amount for L=13, it decreases by 4. a factor of about 250 000 if μ changes from 1 10 However, PWF L are far less sensitive to a change in μ in L and PM particular, PM 13 changes only by a factor of about 4 if μ changes 4.
4 to 3 10 from 1 10  4 to 3 10 [10:11 15/5/2009 Bioinformatics-btp227.tex] Page: i193 i187 i195 i193  A.Bhaskar and Y.S.Song F W L P / ML P 160 140 120 100 80 60 40 20 0 µ= 5 10 3 µ= 1 10 3 µ= 5 10 4 µ= 3 10 4 µ= 2 10 4 0 1 2 3 4 6 5 L 7 8 9 10 11 Fig.5.
The ratio of PM L to PWF L for Ne=10000 and various values of μ. Table 3.
MPs for Ne=109 and μ=10  8, which correspond to θ =40 L 1 2 3 4 5 6 7 8 9 1/(1+θ)L 2.44 10 2 5.95 10 4 1.45 10 5 3.54 10 7 8.63 10 9 2.11 10 10 5.13 10 12 1.25 10 13 3.05 10 15 PWF L 2.44 10 5.95 10 1.45 10 3.54 10 8.63 10 2.11 10 5.34 10 1.79 10 1.75 10  2 4 5 7 9 10 12 13 14 PM L 2.44 10 5.95 10 1.45 10 3.54 10 8.65 10 2.20 10 9.86 10 2.52 10 1.22 10  2 4 5 7 9 10 12 12 12 is relevant Since the accuracy of the product rule is highly sensitive to mutation rates, one important question is, What range of mutation rates in the inﬁnite alleles model to microsatellite loci  The observed homozygosity at the CODIS microsatellite loci typically ranges between 0.1 and 0.3, with the average over all 13 loci being about 0.2 (Budowle et al., 2001). Under the inﬁnite alleles model with Ne=10000, ESF implies that homozygosity=0.2 4.
For this value of μ, Table 2 shows that corresponds to μ=10 the product rule is reasonably accurate, especially for L 10 and 4, which corresponds to for the WF model.
But, for μ=2 10 homozygosity = 0.11, the product rule produces considerably less accurate MPs. /PWF L increases with μ. 8.2 WF versus Moran Table 2 reveals a striking difference between the WF and Moran models.
The two models agree very well in the single locus case (i.e. L=1). However, for large values of L, PM L in the Moran model can be orders of magnitude higher than PWF L in the WF model.
As Figure 5 shows, for a given mutation rate μ, the ratio PM /PWF L L increases rapidly with the number L of loci.
For a given L, the ratio PM As μ 0 and NWF  while θ =4Neμ=4NWFμ is held ﬁxed, L in (10) approaches 1/(1+θ), one can analytically show that PWF 1 which agrees with the ESF mentioned in the previous section.
Likewise, as μ 0 and NM  while θ =4Neμ=2NMμ is held 1 in (11) approaches 1/(1+θ). Therefore, as expected PWF ﬁxed, PM 1 and PM 1 converge to the same value in the diffusion limit.
For L 1, we used our software to check numerically that both PWF L and PM converge to 1/(1+θ)L in the diffusion limit.
However, for large L values of L, the rate of convergence for the Moran model seems much slower than that for the WF model.
Table 3 illustrates this 8, which correspond to θ =40, PWF point.
For Ne=109 and μ=10 for L 6 are much closer to 1/(1+θ)L than are PM L. L 8.3 The 2-locus case with a variable recombination rate In the case of two loci, we can symbolically solve the coupled equations in Figure 4 to obtain an analytic formula for PM 2 for the Moran model.
Likewise, we can symbolically solve the coupled equations in Figure 10 of Song and Slatkin (2007) to obtain an of r [0, 1 ] analytic formula for PWF 2 for the WF model.
The value r 2 for which the ratio PM is maximized depends on Ne and μ. /PWF  0.129 for μ=5 10 4, 2 2 For example, with Ne ﬁxed at 10000, r 3 and r  0.224 for μ=1 10 = 1 2 for μ=5 10 r  3.
8.4 Excluding siblings To estimate the contribution of close relatives to MPs, we want to compute MPs conditioned on the event that the two individuals being compared are neither full-sibs nor half-sibs in the WF model.
This computation can be carried out as follows.
Suppose that the two individuals are sampled from generation t. Then, we compute the equilibrium MPs as before and use them as MPs at generation t 1.
To compute MPs at generation t conditioned on the two individuals being non-sibs, we set up a system of restricted recurrence equations, obtained by restricting vertex merge operations to avoid generating sibling relationships.
In the Moran model, it is not clear how the analogs of full-sibs and half-sibs should be deﬁned, so the Moran model is omitted from this discussion.
L and PWF L conditioned on the event that the two individuals being compared are non-sibs. Comparing that table with Table 2, we see that the product rule becomes much more accurate if we are provided with the additional information that the individuals being compared are not close relatives.
Shown in Table 4 are π WF 9 DISCUSSION For a ﬁnite population, we have shown that the accuracy of multi- locus MPs predicted by the product rule is highly sensitive to 4, mutation rates in the range of interest.
For Ne=10000 and μ=10 the product rule provides a reasonable approximation to the true MP, 4) can but slightly increasing the mutation rate (say, to μ=2 10 change this conclusion dramatically.
There is no doubt that the true 13-locus MP at the CODIS loci is a very small number, but it is important to ﬁnd out how small it is, as the following recent work illustrates: Song et al. (2009) considered a hypothetical series of criminal cases in which a suspect is identiﬁed based only on cold hit , i.e. the DNA proﬁle of a crime-scene sample is found to match a known proﬁle in a DNA database.
They showed that the average probability that a cold hit in a DNA database search results in an erroneous attribution is approximately equal to twice the number of individuals in the population not in the database times the average MP.
Hence, since the population size is very large, an increase by several orders of magnitude in the MP may change the above probability of erroneous attribution from being negligibly small to being non-negligible.
The reader should bear in mind that the results described here pertain to a simpliﬁed, ideal ﬁnite population.
The models we consider ignore several important aspects of human genetics.
In particular, monogamy is ignored for simplicity, while Song and i194 [10:11 15/5/2009 Bioinformatics-btp227.tex] Page: i194 i187 i195  Multi-locus match probability in a ﬁnite population Table 4.
MPs between non-siblings in the WF model with Ne=10 000 L 1 2 3 4 5 6 7 8 9 10 Non-sib π WF L μ=1 10 4 2.00 10 1 4.00 10 2 7.99 10 3 1.60 10 3 3.19 10 4 6.39 10 5 1.28 10 5 2.55 10 6 5.10 10 7 1.02 10 7 Non-sib PWF L 2.00 10 4.00 10 7.99 10 1.60 10 3.20 10 6.39 10 1.28 10 2.56 10 5.12 10 1.03 10  1 2 3 3 4 5 5 6 7 7 Non-sib π WF L μ=5 10 4 4.75 10 2 2.26 10 3 1.07 10 4 5.11 10 6 2.43 10 7 1.15 10 8 5.48 10 10 2.61 10 11 1.24 10 12 5.89 10 14 Non-sib PWF L 4.75 10 2.26 10 1.08 10 5.20 10 2.54 10 1.28 10 6.81 10 4.02 10 2.76 10 2.23 10  2 3 4 6 7 8 10 11 12 13 Non-sib π WF L μ=1 10 3 2.43 10 2 5.91 10 4 1.44 10 5 3.49 10 7 8.48 10 9 2.06 10 10 5.01 10 12 1.22 10 13 2.96 10 15 7.19 10 17 Non-sib PWF L 2.43 10 5.95 10 1.48 10 3.93 10 1.22 10 5.19 10 3.15 10 2.39 10 2.00 10 1.74 10  2 4 5 7 8 10 11 12 13 14 Non-sib π WF L μ=5 10 3 4.89 10 3 2.39 10 5 1.17 10 7 5.71 10 10 2.79 10 12 1.36 10 14 6.67 10 17 3.26 10 19 1.59 10 21 7.79 10 24 Non-sib PWF L 4.89 10 2.78 10 3.67 10 1.62 10 1.01 10 6.68 10 4.48 10 3.06 10 2.16 10 1.61 10  3 5 7 8 9 11 12 13 14 15 Slatkin (2007) showed that monogamy increases the probabilities of matches at unlinked loci and that the effect of monogamy increases with the number of loci.
Other relevant features that should be explored include diploidy and population structure.
Another limitation of our study, which also applies to that of Laurie and Weir (2003) and Song and Slatkin (2007), is that we assume an inﬁnite alleles model of mutation as such, we do not allow for independent origins of the same allele, as can happen with microsatellite loci.
In the inﬁnite alleles model, identity in allelic state implies identity by descent.
Our work studies the effect of shared genealogies in a ﬁnite population on the joint probability of identity by descent.
Regarding this question, our work applies to other mutation models as well.
As an important by-product of our work on MP computation, we have revealed a fundamental difference between the WF and Moran models, which are two standard models widely used in population genetics.
We have shown that the difference in MPs in the two models increases with the number of loci.
It will be interesting to provide a genealogical interpretation of this ﬁnding. We speculate that the times to the most recent common ancestors at unlinked loci are more correlated in the Moran model than in the WF model.
Given the results discussed in this article, it is tempting to suspect that other quantities, such as linkage disequilibrium, of interest to population geneticists may be fundamentally different in the two models, especially when many loci are considered.
Consequently, it seems pertinent to think about which random mating model is more appropriate for humans.
ACKNOWLEDGEMENTS We thank Charles H. Langley, Rasmus Nielsen, Joshua Paul and Monty Slatkin for helpful comments and discussion.
Funding: Berkeley Graduate Fellowship (A.B., inpart) an National Institutes of health (R00-GM080099, inpart) an to Y.S.S., Alfred P. Sloan Research Fellowship (to Y.S.S., inpart) Packard Fellowship for Science and Engineering (to Y.S.S., inpart). Conﬂict of Interest: none declared.
REFERENCES Balding,D.J. (2005) Weight-of-Evidence for Forensic DNA Proﬁles. John Wiley and Sons Ltd, Chichester, England. Budowle,B. et al. (2001) CODIS STR loci data from 41 sample populations.
J. Forensic Sci., 46, 453 489.
Evett,I.W. and Weir,B.S. (1998) Interpreting DNA Evidence.
Sinauer Associates, Sunderland, MA.
Ewens,W.J. (1972) The sampling theory of selectively neutral alleles.
Theor. Popul. Biol., 3, 87 112.
Ewens,W.J. (2004) Mathematical Population Genetics: I.
Theoretical Introduction.
Springer Science + Business Media, Inc., New York. Harary,F. and Palmer,E.M. (1973) Graphical Enumeration.
Academic Press, New York. Harding,R.M. et al. (1997). Archaic African and Asian lineages in the genetic ancestry of modern humans.
Am.
J. Hum.
Genet., 60, 772 789.
Harpending, H.C. et al. (1998) Genetic traces of ancient demography.
Proc. Natl Acad. Sci.USA 95, 1961 1967.
Labelle,G. (2000). Counting enriched multigraphs according to the number of their edges (or arcs). Discrete Math., 217, 237 248.
Laurie,C. and Weir,B.S. (2003) Dependency effects in multi-locus match probabilities.
McKay,B.D. Theor. Popul. Biol., 63, 207 219. http://cs.anu.edu.au/ bdm/nauty/ (last accessed date April 23, 2009). (2007) Nauty (version user s guide 2.4). available at Pritchard,J.K. et al. (2000) Inference of population structure using multilocus genotype data.
Genetics, 155, 945 959.
Song,Y.S. and Slatkin,M. (2007) A graphical approach to multi-locus match probability computation: revisiting the product rule.
Theor. Popul. Biol., 72, 96 110.
Song,Y.S. et al. (2009) Average probability that a Cold Hit in a DNA database search results in an erroneous attribution.
J. Forensic Sci., 54, 22 27. i195 [10:11 15/5/2009 Bioinformatics-btp227.tex] Page: i195 i187 i195 